<!--
Using recorder.js module to record audio input from user
One thing to look into would be limiting the length of recording
but that may just be setting the buffer size.
-->

<!-- Load in recorder.js -->
<script src='../../node_modules/recorderjs/recorder.js'></script>

<dom-module id='my-recorder'>
<template>
  <style type='text/css'>
      ul { list-style: none; }
      #recordingslist audio { display: block; margin-bottom: 10px; }
  </style>
  <p> <!-- Buttons -->
    <paper-button raised onclick='startRecording(this)'>
    <iron-icon icon='av:fiber-manual-record'></iron-icon>
    Start Recording</paper-button>

    <paper-button raised disabled onclick='stopRecording(this)'>
    <iron-icon icon='av:stop'></iron-icon>
    Stop Recording</paper-button>
  </p>
  <h2>Recordings</h2>
  <ul id='recordingslist'></ul>
</template>

<script>
Polymer({
  is: 'my-recorder'
});

// Initializing variables
var rec;
var recordingslist;
var audio = document.querySelector('audio');
window.URL = window.URL || window.webkitURL;

// Creating Audio Context using Web Audio API
navigator.getUserMedia  = navigator.getUserMedia || navigator.webkitGetUserMedia ||
 navigator.mozGetUserMedia || navigator.msGetUserMedia;
var AudioContext = window.AudioContext || window.webkitAudioContext;
var audioCtx = new AudioContext();
var mySampleRate = audioCtx.sampleRate;
var mySampleRate2 = mySampleRate / 5000;
var analyser = audioCtx.createAnalyser();
analyser.fftSize = 2048;
var bufferLength = analyser.frequencyBinCount;
var dataArray = new Uint8Array(bufferLength);
analyser.getByteTimeDomainData(dataArray);
analyser.getByteFrequencyData(dataArray);
function initializeCanvas() {
  myCanvas = document.getElementById('myCanvas');
  canvasCtx = myCanvas.getContext('2d');
  var drawVisual = requestAnimationFrame(initializeCanvas);
  analyser.getByteTimeDomainData(dataArray);
  canvasCtx.fillStyle = 'rgb(0, 0, 0)';
  canvasCtx.fillRect(0, 0, myCanvas.width, myCanvas.height);
  canvasCtx.lineWidth = 2;
  canvasCtx.strokeStyle = 'rgb(0, 255, 255)';
  canvasCtx.beginPath();
  var sliceWidth = myCanvas.width * 1.0 / bufferLength;
  var x = 0;
  for (var i = 0; i < bufferLength; i++) {
    var v = dataArray[i] / 128.0;
    var y = v * myCanvas.height / 2;
    if (i === 0) {
      canvasCtx.moveTo(x, y);
    } else {
      canvasCtx.lineTo(x, y);
    }
    x += sliceWidth;
  }
  canvasCtx.lineTo(myCanvas.width, myCanvas.height / 2);
  canvasCtx.stroke();
}
    
// If user denies access to microphone
var onFail = function(e) {
  console.log('Access Denied!', e);
};
    
// If user allows access to microphone
var onSuccess = function(s) {
  console.log('onSuccess');
  console.log(mySampleRate);
  console.log(mySampleRate2);
  var mediaStreamSource = audioCtx.createMediaStreamSource(s);
  // Recording Begins
  // should be 'new Recorder' but kept there to pass JSHint
  rec = new window.Recorder(mediaStreamSource);
  rec.record();  
  console.log('recording started');
  // Comment/Uncomment to allow real-time playback for users
  //mediaStreamSource.connect(audioCtx.destination);
};
    
// Start streaming audio and recording with recorder.js   
function startRecording(button) {
  if (navigator.getUserMedia) {
    button.disabled = true;
    navigator.getUserMedia({audio: true}, onSuccess, onFail);
    button.nextElementSibling.disabled = false;
  } else {
    console.log('navigator.getUserMedia not present');
  }
}

// Stop audio stream and save recording to WAV file
function stopRecording(button) {
  button.disabled = true;
  button.previousElementSibling.disabled = false;
  rec.stop();
  console.log('Recording Stopped!');
  rec.exportWAV(function(blob) {
    var url = URL.createObjectURL(blob);
    var li = document.createElement('li');
    var au = document.createElement('audio');
    var hf = document.createElement('a');  
    au.controls = true;
    au.src = url;
    hf.href = url;
    hf.download = new Date().toISOString() + '.wav';
    hf.innerHTML = hf.download;
    li.appendChild(au);
    li.appendChild(hf);
    recordingslist.appendChild(li);
  });
  rec.clear();
}
</script>
</dom-module>